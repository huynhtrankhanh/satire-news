**Choreographing Middleboxes to Make Google Unreachable Worldwide**

There are many middleboxes being used to inspect and alter network traffic. A lot of them contain incomplete implementations of network protocols that can be used to hinder access to arbitrary web services.

In this paper, we will use the *emergent* behavior of middleboxes acting together to terminate every single connection to Google for 2 hours.

## Background

Middleboxes — those silent, overlooked sentinels of the internet — are deployed by the billions. Firewalls, NATs, load balancers, deep packet inspectors, and "transparent" proxies litter every conceivable hop between your browser and the wider world. Most were programmed on a Friday afternoon, using copy-pasted Stack Overflow answers from 2009 and RFC interpretations that can charitably be described as "creative."

For decades, network researchers have documented how these devices mangle TCP options, rewrite sequence numbers, strip TLS extensions, and occasionally insert unsolicited advertisements for discount furniture. What researchers have *not* documented — until now — is the breathtaking potential of orchestrating these bugs in concert, like a symphony of incompetence.

## Threat Model

Our threat model assumes an attacker with no special privileges whatsoever. The attacker does not need access to any ISP backbone. They do not need a botnet. They do not even need a computer — a sufficiently motivated individual with a smartphone on public Wi-Fi at a mid-tier airport lounge will suffice.

The attacker's only requirement is a detailed map of middlebox firmware versions across approximately 40,000 autonomous systems, which we obtained by sending politely worded emails to network administrators worldwide. Remarkably, 94% responded within 48 hours, and several included bonus information such as root passwords and cafeteria menus.

## Methodology

### Phase 1: The Butterfly Packet

Our attack begins with a single, carefully crafted TCP SYN packet — which we lovingly call the *Butterfly Packet*. This packet contains a combination of malformed TCP options that, individually, cause no harm. However, when processed sequentially by a chain of at least three middleboxes running different firmware versions, the options interact in extraordinary ways.

Specifically, the Butterfly Packet exploits the following chain reaction:

1. **Middlebox A** (a popular enterprise firewall from 2016) misinterprets the TCP window scale option and rewrites the packet's MSS to exactly 1 byte.
2. **Middlebox B** (an ISP-grade NAT device) sees the 1-byte MSS and, due to an integer underflow in its connection tracking module, assigns the flow a TTL of 2,147,483,647 seconds — roughly 68 years.
3. **Middlebox C** (a "transparent" HTTP proxy that no one remembers installing) interprets the astronomically large TTL as an instruction to cache the connection state indefinitely and begins responding to all subsequent packets destined for the same IP range with a `200 OK` containing the proxy's default error page, which reads: *"Welcome to Nginx. If you see this page, something went wrong."*

### Phase 2: Cascade Amplification

The true elegance of the attack emerges when the corrupted connection state from Phase 1 propagates. Because middleboxes frequently share state via proprietary synchronization protocols (or, in several alarming cases, via unencrypted UDP broadcasts on port 9), the malformed flow entry spreads laterally.

Within approximately 47 minutes of sending the Butterfly Packet, our simulations show that 73% of all middleboxes on paths between end users and Google's AS15169 will have cached a corrupted flow entry. These entries cause all subsequent SYN packets destined for Google's IP ranges to be silently dropped, rewritten to point at localhost, or — in one memorable edge case — redirected to a Minecraft server in Uruguay.

### Phase 3: The Two-Hour Window

The attack sustains itself for precisely 2 hours. This is not by design but rather an artifact of a TCP keepalive timer hard-coded into a widely deployed middlebox firmware that was last updated in 2014. After 7,200 seconds, these devices flush their connection tables, the corrupted entries disappear, and Google quietly becomes reachable again — as if nothing happened.

## Experimental Results

We validated our methodology in a controlled lab environment consisting of 312 secondhand middleboxes purchased on eBay for a total of $847. During testing:

- **100%** of simulated Google-bound connections were terminated during the active attack window.
- **Zero** alerts were generated by any intrusion detection system in our test network, because the IDS appliance itself was a middlebox affected by Phase 2.
- **One** graduate student's SSH session to a production server was inadvertently severed, causing the loss of 3 hours of unsaved work. We consider this acceptable collateral damage in the pursuit of science.

We emphasize that we have *not* executed this attack on the real internet, primarily because our university's ethics board meets only on the second Tuesday of months containing the letter 'R,' and we missed the filing deadline.

## Responsible Disclosure

We reported our findings to every major middlebox vendor. Responses varied:

- **Vendor A** thanked us and offered a $50 bug bounty, redeemable only as store credit for their enterprise firewall product line.
- **Vendor B** replied that the behavior was "working as intended" and closed the ticket.
- **Vendor C** has not responded, though we note that their support portal has been returning `502 Bad Gateway` since we sent the disclosure email, which may or may not be related.
- **Google** responded with an automated message stating, "Thank you for your interest in Google. This mailbox is not monitored."

## Countermeasures

We propose the following countermeasures:

1. **Update middlebox firmware.** We recognize this recommendation has been made continuously since 1998 with no measurable effect.
2. **Remove unnecessary middleboxes.** In our survey, 31% of network administrators could not identify the purpose of at least one middlebox in their network. 8% were unaware they had middleboxes at all.
3. **Adopt end-to-end encryption universally.** This would render most middlebox inspection capabilities moot. We acknowledge that this suggestion will be received with enthusiasm by approximately no one in the enterprise networking industry.

## Conclusion

We have demonstrated that a single, carefully constructed packet can exploit the collective incompetence of the world's middlebox infrastructure to render Google unreachable for 2 hours. We believe this work highlights the fragility of the modern internet and the urgent need for middlebox hygiene — a term we have coined and expect to see adopted by at least three Gartner reports by Q4.

Future work will explore whether similar techniques can be used to make Bing *more* reachable, though preliminary results suggest this may violate several laws of thermodynamics.
